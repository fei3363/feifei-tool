<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>文字差異比對工具</title>
    <meta name="description" content="文字差異比對工具 - 比較兩個文字內容的差異" />
    <meta name="keywords" content="文字差異比對工具,文字比對,差異比較,工具" />
    <meta name="author" content="FeiFei" />
    <!-- Noto Sans TC 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- diff_match_patch 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f5f5f5;
        }
        .diff-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .diff-added {
            background-color: #d4f4dd;
            color: #22863a;
            text-decoration: none;
            display: inline;
            padding: 2px 0;
            border-radius: 3px;
        }
        .diff-removed {
            background-color: #ffeef0;
            color: #cb2431;
            text-decoration: line-through;
            display: inline;
            padding: 2px 0;
            border-radius: 3px;
        }
        .diff-equal {
            background-color: transparent;
            color: inherit;
        }
        .stats-container {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .stats-item {
            display: inline-block;
            margin-right: 20px;
            font-weight: 500;
        }
        .diff-result {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 200px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
        }
        .view-mode {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .view-mode label {
            margin-right: 15px;
            cursor: pointer;
        }
        .line-by-line {
            border-left: 3px solid #ddd;
            padding-left: 15px;
            margin: 10px 0;
        }
        .line-number {
            color: #999;
            font-size: 0.9em;
            margin-right: 10px;
            display: inline-block;
            width: 40px;
            text-align: right;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        @media (max-width: 768px) {
            .diff-container {
                grid-template-columns: 1fr;
            }
            .stats-item {
                display: block;
                margin-bottom: 5px;
            }
        }
        .highlight-changes {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .textarea-container {
            position: relative;
        }
        .char-count {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #666;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
        }
        .diff-inline {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .diff-inline.added {
            background-color: #e6ffed;
            border-left: 3px solid #28a745;
        }
        .diff-inline.removed {
            background-color: #ffeef0;
            border-left: 3px solid #dc3545;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">文字差異比對工具</h1>
        
        <div class="bg-blue-100 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-sm">比較兩段文字的差異，標示新增、刪除和修改的部分。</p>
            <p class="text-sm mt-1">支援：<span class="diff-added">新增內容</span>、<span class="diff-removed">刪除內容</span>、字元級別比對</p>
        </div>

        <div class="diff-container">
            <div>
                <label for="text1" class="block mb-2 font-semibold">原始文字：</label>
                <div class="textarea-container">
                    <textarea 
                        id="text1" 
                        class="w-full p-3 border rounded-lg resize-vertical"
                        placeholder="貼上或輸入原始文字..."
                        rows="10"
                        oninput="updateCharCount('text1')"
                    ></textarea>
                    <span class="char-count" id="text1-count">0 字元</span>
                </div>
            </div>
            <div>
                <label for="text2" class="block mb-2 font-semibold">新版文字：</label>
                <div class="textarea-container">
                    <textarea 
                        id="text2" 
                        class="w-full p-3 border rounded-lg resize-vertical"
                        placeholder="貼上或輸入新版文字..."
                        rows="10"
                        oninput="updateCharCount('text2')"
                    ></textarea>
                    <span class="char-count" id="text2-count">0 字元</span>
                </div>
            </div>
        </div>

        <div class="view-mode">
            <span class="font-semibold">顯示模式：</span>
            <label>
                <input type="radio" name="viewMode" value="inline" checked> 行內顯示
            </label>
            <label>
                <input type="radio" name="viewMode" value="sideBySide"> 並排顯示
            </label>
            <label>
                <input type="radio" name="viewMode" value="unified"> 統一顯示
            </label>
        </div>

        <div class="flex gap-2 flex-wrap">
            <button 
                onclick="compareTexts()" 
                class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition"
            >
                開始比對
            </button>
            <button 
                onclick="clearAll()" 
                class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition"
            >
                清除內容
            </button>
            <button 
                onclick="swapTexts()" 
                class="bg-purple-500 text-white px-6 py-2 rounded hover:bg-purple-600 transition"
            >
                交換文字
            </button>
            <button 
                onclick="loadExample()" 
                class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 transition"
            >
                載入範例
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>比對中...</p>
        </div>

        <div id="stats" class="stats-container" style="display: none;">
            <div class="stats-item">
                <span class="text-green-600">✚ 新增：</span>
                <span id="addedCount">0</span> 字元
            </div>
            <div class="stats-item">
                <span class="text-red-600">✖ 刪除：</span>
                <span id="removedCount">0</span> 字元
            </div>
            <div class="stats-item">
                <span class="text-blue-600">✎ 修改：</span>
                <span id="changedCount">0</span> 處
            </div>
            <div class="stats-item">
                <span class="text-gray-600">相似度：</span>
                <span id="similarity">0</span>%
            </div>
        </div>

        <div id="diffResult" style="display: none;">
            <h3 class="text-lg font-semibold mb-3">比對結果：</h3>
            <div class="export-buttons">
                <button onclick="exportAsText()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                    匯出為文字
                </button>
                <button onclick="exportAsHTML()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    匯出為 HTML
                </button>
                <button onclick="copyDiff()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">
                    複製差異
                </button>
            </div>
            <div id="diffContent" class="diff-result mt-4"></div>
        </div>
    </div>

    <script>
        let dmp = new diff_match_patch();
        let currentDiffs = [];

        function updateCharCount(textareaId) {
            const textarea = document.getElementById(textareaId);
            const count = textarea.value.length;
            document.getElementById(`${textareaId}-count`).textContent = `${count} 字元`;
        }

        function compareTexts() {
            const text1 = document.getElementById('text1').value;
            const text2 = document.getElementById('text2').value;
            
            if (!text1.trim() && !text2.trim()) {
                alert('請輸入要比對的文字');
                return;
            }

            // 顯示載入動畫
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                // 執行差異比對
                currentDiffs = dmp.diff_main(text1, text2);
                dmp.diff_cleanupSemantic(currentDiffs);
                
                // 計算統計資料
                calculateStats();
                
                // 顯示結果
                displayDiff();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'block';
                document.getElementById('diffResult').style.display = 'block';
            }, 100);
        }

        function calculateStats() {
            let added = 0, removed = 0, changed = 0;
            let totalChars = 0;
            let equalChars = 0;
            
            currentDiffs.forEach(diff => {
                const [operation, text] = diff;
                const length = text.length;
                
                if (operation === 1) { // 新增
                    added += length;
                } else if (operation === -1) { // 刪除
                    removed += length;
                } else { // 相等
                    equalChars += length;
                }
                
                if (operation !== 1) {
                    totalChars += length;
                }
            });
            
            // 計算修改數（簡化計算）
            changed = Math.min(added, removed);
            
            // 計算相似度
            const similarity = totalChars > 0 ? Math.round((equalChars / totalChars) * 100) : 0;
            
            document.getElementById('addedCount').textContent = added;
            document.getElementById('removedCount').textContent = removed;
            document.getElementById('changedCount').textContent = changed;
            document.getElementById('similarity').textContent = similarity;
        }

        function displayDiff() {
            const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
            const diffContent = document.getElementById('diffContent');
            
            let html = '';
            
            if (viewMode === 'inline') {
                currentDiffs.forEach(diff => {
                    const [operation, text] = diff;
                    if (operation === 1) {
                        html += `<span class="diff-added">${escapeHtml(text)}</span>`;
                    } else if (operation === -1) {
                        html += `<span class="diff-removed">${escapeHtml(text)}</span>`;
                    } else {
                        html += `<span class="diff-equal">${escapeHtml(text)}</span>`;
                    }
                });
            } else if (viewMode === 'sideBySide') {
                html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                html += '<div><h4 class="font-semibold mb-2">原始文字</h4><div class="diff-result">';
                currentDiffs.forEach(diff => {
                    const [operation, text] = diff;
                    if (operation === -1) {
                        html += `<span class="diff-removed">${escapeHtml(text)}</span>`;
                    } else if (operation === 0) {
                        html += `<span class="diff-equal">${escapeHtml(text)}</span>`;
                    }
                });
                html += '</div></div>';
                
                html += '<div><h4 class="font-semibold mb-2">新版文字</h4><div class="diff-result">';
                currentDiffs.forEach(diff => {
                    const [operation, text] = diff;
                    if (operation === 1) {
                        html += `<span class="diff-added">${escapeHtml(text)}</span>`;
                    } else if (operation === 0) {
                        html += `<span class="diff-equal">${escapeHtml(text)}</span>`;
                    }
                });
                html += '</div></div></div>';
            } else { // unified
                currentDiffs.forEach(diff => {
                    const [operation, text] = diff;
                    const lines = text.split('\n');
                    
                    lines.forEach((line, index) => {
                        if (index === lines.length - 1 && line === '') return;
                        
                        if (operation === 1) {
                            html += `<div class="diff-inline added">+ ${escapeHtml(line)}</div>`;
                        } else if (operation === -1) {
                            html += `<div class="diff-inline removed">- ${escapeHtml(line)}</div>`;
                        } else {
                            html += `<div class="diff-inline">  ${escapeHtml(line)}</div>`;
                        }
                    });
                });
            }
            
            diffContent.innerHTML = html;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function clearAll() {
            document.getElementById('text1').value = '';
            document.getElementById('text2').value = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('diffResult').style.display = 'none';
            updateCharCount('text1');
            updateCharCount('text2');
            currentDiffs = [];
        }

        function swapTexts() {
            const text1 = document.getElementById('text1').value;
            const text2 = document.getElementById('text2').value;
            document.getElementById('text1').value = text2;
            document.getElementById('text2').value = text1;
            updateCharCount('text1');
            updateCharCount('text2');
        }

        function loadExample() {
            document.getElementById('text1').value = 
`這是一個範例文字。
它包含了幾行內容。
用來展示文字比對功能。
原始版本的內容就是這樣。`;
            
            document.getElementById('text2').value = 
`這是一個修改過的範例文字。
它包含了幾行不同的內容。
用來展示文字比對功能的強大。
新版本增加了這一行。
原始版本的內容已經被更新了。`;
            
            updateCharCount('text1');
            updateCharCount('text2');
        }

        function exportAsText() {
            let text = '文字差異比對結果\n';
            text += '================\n\n';
            
            currentDiffs.forEach(diff => {
                const [operation, content] = diff;
                if (operation === 1) {
                    text += `[新增] ${content}\n`;
                } else if (operation === -1) {
                    text += `[刪除] ${content}\n`;
                }
            });
            
            downloadFile('diff_result.txt', text);
        }

        function exportAsHTML() {
            let html = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>文字差異比對結果</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .diff-added { background-color: #d4f4dd; color: #22863a; }
        .diff-removed { background-color: #ffeef0; color: #cb2431; text-decoration: line-through; }
    </style>
</head>
<body>
    <h1>文字差異比對結果</h1>
    <div>`;
            
            currentDiffs.forEach(diff => {
                const [operation, text] = diff;
                if (operation === 1) {
                    html += `<span class="diff-added">${escapeHtml(text)}</span>`;
                } else if (operation === -1) {
                    html += `<span class="diff-removed">${escapeHtml(text)}</span>`;
                } else {
                    html += escapeHtml(text);
                }
            });
            
            html += '</div></body></html>';
            downloadFile('diff_result.html', html);
        }

        function copyDiff() {
            let text = '';
            currentDiffs.forEach(diff => {
                const [operation, content] = diff;
                if (operation === 1) {
                    text += `[+] ${content}`;
                } else if (operation === -1) {
                    text += `[-] ${content}`;
                } else {
                    text += content;
                }
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('差異內容已複製到剪貼簿');
            }).catch(err => {
                console.error('複製失敗:', err);
                alert('複製失敗，請手動選取複製');
            });
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // 監聽顯示模式變更
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (currentDiffs.length > 0) {
                    displayDiff();
                }
            });
        });

        // 支援 Tab 鍵在文字框中輸入
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    textarea.value = textarea.value.substring(0, start) + '\t' + textarea.value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + 1;
                }
            });
        });
    </script>
</body>
</html>
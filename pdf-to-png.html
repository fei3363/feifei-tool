<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>PDF è½‰ PNG </title>
    <meta name="description" content="PDF è½‰ PNG " />
    <meta name="keywords" content="PDF è½‰ PNG ,å·¥å…·" />
    <meta name="author" content="FeiFei" />
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- JSZip for downloading all images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        #images img {
            margin-top: 15px;
            max-width: 100%;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <!-- å°èˆªæ¬„ -->
        <div class="flex flex-wrap space-x-2 border-b mb-4 is-fluid">
            <a class="px-4 py-2 text-blue-600" href="text-stats.html">æ–‡å­—çµ±è¨ˆ</a>
            <a class="px-4 py-2 text-blue-600" href="chinese-conversion.html">ç¹ç°¡è½‰æ›</a>
            <a class="px-4 py-2 text-blue-600 border-b-2 border-blue-500" href="pdf-to-png.html">PDF è½‰ PNG</a>
        </div>

        <h1 class="text-2xl font-bold mb-4">PDF è½‰ PNG è½‰æ›å™¨</h1>

        <div class="space-y-4 my-4">
            <div class="field">
                <label for="pdfInput">é¸æ“‡PDFæ–‡ä»¶ï¼š</label>
                <input type="file" id="pdfInput" class="w-full p-2 border rounded" multiple accept="application/pdf">
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="convertButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">ç¢ºèªè½‰æ›</button>
                <button id="downloadAllButton" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded transition-colors hidden">
                    <span id="downloadText">ğŸ“¥ ä¸€æ¬¡ä¸‹è¼‰å…¨éƒ¨ PNG</span>
                    <span id="downloadLoading" class="hidden">â³ æ‰“åŒ…ä¸­...</span>
                </button>
                <button id="clearButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors hidden">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
            </div>
        </div>

        <div id="status" class="text-gray-600 mb-2 hidden"></div>
        <div id="images" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <script>
        // å„²å­˜æ‰€æœ‰è½‰æ›å¾Œçš„åœ–ç‰‡è³‡æ–™
        let convertedImages = [];

        document.getElementById('convertButton').addEventListener('click', async () => {
            const files = document.getElementById('pdfInput').files;
            if (files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ PDF æ–‡ä»¶');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„çµæœ
            convertedImages = [];
            document.getElementById('images').innerHTML = '';
            document.getElementById('downloadAllButton').classList.add('hidden');
            document.getElementById('clearButton').classList.add('hidden');

            const statusEl = document.getElementById('status');
            statusEl.classList.remove('hidden');
            statusEl.textContent = 'è½‰æ›ä¸­...';

            for (let i = 0; i < files.length; i++) {
                statusEl.textContent = `æ­£åœ¨è½‰æ›ç¬¬ ${i + 1}/${files.length} å€‹æ–‡ä»¶...`;
                await convertPDFToImages(files[i]);
            }

            statusEl.textContent = `è½‰æ›å®Œæˆï¼å…± ${convertedImages.length} å¼µåœ–ç‰‡`;
            
            if (convertedImages.length > 0) {
                document.getElementById('downloadAllButton').classList.remove('hidden');
                document.getElementById('clearButton').classList.remove('hidden');
            }
        });

        document.getElementById('downloadAllButton').addEventListener('click', async () => {
            if (convertedImages.length === 0) {
                alert('æ²’æœ‰å¯ä¸‹è¼‰çš„åœ–ç‰‡');
                return;
            }

            const downloadText = document.getElementById('downloadText');
            const downloadLoading = document.getElementById('downloadLoading');
            const downloadBtn = document.getElementById('downloadAllButton');

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            downloadText.classList.add('hidden');
            downloadLoading.classList.remove('hidden');
            downloadBtn.disabled = true;

            try {
                const zip = new JSZip();
                
                // å°‡æ‰€æœ‰åœ–ç‰‡åŠ å…¥ ZIP
                convertedImages.forEach((imgData, index) => {
                    // å¾ base64 data URL ä¸­æå–ç´” base64 è³‡æ–™
                    const base64Data = imgData.dataUrl.split(',')[1];
                    const fileName = `${imgData.fileName}_page${imgData.pageNum}.png`;
                    zip.file(fileName, base64Data, { base64: true });
                });

                // ç”Ÿæˆ ZIP ä¸¦ä¸‹è¼‰
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pdf-images-${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('æ‰“åŒ…å¤±æ•—:', error);
                alert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                downloadText.classList.remove('hidden');
                downloadLoading.classList.add('hidden');
                downloadBtn.disabled = false;
            }
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            convertedImages = [];
            document.getElementById('images').innerHTML = '';
            document.getElementById('downloadAllButton').classList.add('hidden');
            document.getElementById('clearButton').classList.add('hidden');
            document.getElementById('status').classList.add('hidden');
            document.getElementById('pdfInput').value = '';
        });

        async function convertPDFToImages(file) {
            return new Promise((resolve) => {
                const fileReader = new FileReader();
                const fileName = file.name.replace('.pdf', '');

                fileReader.onload = async (e) => {
                    const typedArray = new Uint8Array(e.target.result);
                    const pdfDoc = await pdfjsLib.getDocument(typedArray).promise;

                    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                        const page = await pdfDoc.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 1.5 });

                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({
                            canvasContext: ctx,
                            viewport: viewport
                        }).promise;

                        const dataUrl = canvas.toDataURL('image/png');

                        // å„²å­˜åœ–ç‰‡è³‡æ–™
                        convertedImages.push({
                            fileName: fileName,
                            pageNum: pageNum,
                            dataUrl: dataUrl
                        });

                        // å»ºç«‹åœ–ç‰‡å®¹å™¨
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'bg-white rounded-lg shadow p-3';

                        // å»ºç«‹åœ–ç‰‡æ¨™é¡Œ
                        const title = document.createElement('p');
                        title.className = 'text-sm text-gray-600 mb-2 font-medium';
                        title.textContent = `${fileName} - ç¬¬ ${pageNum} é `;

                        // å»ºç«‹åœ–ç‰‡
                        const img = document.createElement('img');
                        img.src = dataUrl;
                        img.className = 'rounded border w-full';
                        img.alt = `${fileName} page ${pageNum}`;

                        // å»ºç«‹å–®å¼µä¸‹è¼‰æŒ‰éˆ•
                        const downloadBtn = document.createElement('a');
                        downloadBtn.href = dataUrl;
                        downloadBtn.download = `${fileName}_page${pageNum}.png`;
                        downloadBtn.className = 'inline-block mt-2 text-sm text-blue-500 hover:text-blue-700 cursor-pointer';
                        downloadBtn.textContent = 'ğŸ’¾ ä¸‹è¼‰æ­¤åœ–';

                        imgContainer.appendChild(title);
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(downloadBtn);
                        document.getElementById('images').appendChild(imgContainer);
                    }

                    resolve();
                };

                fileReader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>
</html>
